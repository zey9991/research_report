## Glossary

- **Fee**: Refers to the fee settings related to the V2 PT-AMM pools.
- **The Whitepaper**: Refers to the whitepaper `V2_AMM.pdf` unless otherwise specified.
- **SY** : is a Standardized Yield token.
- **Asset**: Refers to the underlying asset of the SY token.
- **PT** : is a PT token of the same SY token.

## Background

In Pendle V2, a variety of AMM pools are available, allowing traders to swap assets for PT, YT, or vice versa. The swap fee plays a crucial role in shaping the user experience. If the fee is set incorrectly, it can have the following effects:

- **Too High**: This would deter traders from swapping, ultimately reducing the profits of LPs and vePendle voters. Although the fee per transaction may increase, the overall volume of swaps would decrease.
- **Too Low**: This would undermine the profits of LPs and vePendle voters, even though the volume of swaps might increase significantly.

This situation is analogous to a **market competition model** in economics. In such models, a company’s revenue is given by $$R= P \times Q$$, where $$P$$ is the price and $$Q$$ is the quantity sold. If the price is set incorrectly, the revenue will not be optimized, even though the quantity $$Q$$ may fluctuate.

Previously, our team introduced the “Efficient Ratio” as an indicator to measure the effectiveness of fee settings in specific pools. This is similar to the concept of revenue $$R$$ in a market competition model.

In this data-driven report, we aim to explore the following:

- How do different fee tiers affect the “Efficient Ratio”? What is the optimal range according to historical data?
- Has the “Efficient Ratio” functioned well in evaluating the effectiveness of fee settings? If not, is there a more suitable alternative indicator?

## Fee Calculation

In Pendle V2 AMM, there are two types of fees:

- **Explicit Fee**: These are the fees charged according to the specific fee tier of each pool, as displayed in the app. The distribution is as follows:
  - 20% is allocated to LP holders.
  - 80% is distributed to vePENDLE voters.
- **Implicit Fee**: These fees are generated by the formula used to quote the price for each swap. 
  - The formula is “relatively protective of the AMM pool,” meaning it quotes a conservative price to prevent potential exploitation of the AMM. The larger the trade, the higher the implicit fees.
  - They are not the same as price impact (slippage) in general. They are “on the top” of price impact.
  - 100% is allocated to the LP holders

In this section, we will provide a detailed explanation of these two types of fees.

### Explicit Fees

In V2, the explicit fees are described in the whitepaper `V2_AMM.pdf` and implemented in the smart contracts `MarketMathCore.sol` (Core Logic) and `PendleMarketV3.sol`.

The whitepaper defines the amount of assets going in, denoted as $$d_{asset}$$  as a function of the amount of PT tokens going out, denoted as $$d_{pt}$$:

$$
d_{asset}=\frac{d_{pt}}{exchangeRate(t)}\div or \times feeRateRoot^{yearsToExpiry(t)}
$$
where,

- $$exchangeRate(t)$$ is the spot exchange rate of asset in PT at time $$t$$, excluding any fees
- $$feeRateRoot=1+feetier$$
- $$yearsToExpiry(t)$$ is the time remaining until expiry, measured in years

Accordingly, the fee can be computed as follows:

- if $$d_{pt}>0$$ i.e. swapping assets for PT, then 

  $$
  d_{asset}=\frac{d_{pt}}{exchangeRate(t)}\times feeRateRoot^{yearsToExpiry(t)}
  $$
  The fee is:

  $$
  fee=\frac{d_{pt}}{exchangeRate(t)}(feeRateRoot^{yearsToExpiry(t)}-1)
  $$

- if $$d_{pt}<0$$  i.e. swapping PT for assets, then 

  $$
  d_{asset}=\frac{d_{pt}}{exchangeRate(t)}\div feeRateRoot^{yearsToExpiry(t)}
  $$
  The fee is:
  
  $$
  fee=-\frac{d_{pt}}{exchangeRate(t)}(\frac{1-feeRateRoot^{yearsToExpiry(t)}}{feeRateRoot^{yearsToExpiry(t)}})
  $$
  

This logic is implemented in the `calcTrade` function of `MarketMathCore.sol`. The relevant source code is as follows:

```solidity
function calcTrade(
        MarketState memory market,
        MarketPreCompute memory comp,
        PYIndex index,
        int256 netPtToAccount
    ) internal pure returns (int256 netSyToAccount, int256 netSyFee, int256 netSyToReserve) {
        int256 preFeeExchangeRate = _getExchangeRate(
            market.totalPt,
            comp.totalAsset,
            comp.rateScalar,
            comp.rateAnchor,
            netPtToAccount
        );

        int256 preFeeAssetToAccount = netPtToAccount.divDown(preFeeExchangeRate).neg();
        int256 fee = comp.feeRate;

        if (netPtToAccount > 0) {
            int256 postFeeExchangeRate = preFeeExchangeRate.divDown(fee);
            if (postFeeExchangeRate < PMath.IONE) revert Errors.MarketExchangeRateBelowOne(postFeeExchangeRate);

            fee = preFeeAssetToAccount.mulDown(PMath.IONE - fee);
        } else {
            fee = ((preFeeAssetToAccount * (PMath.IONE - fee)) / fee).neg();
        }

        int256 netAssetToReserve = (fee * market.reserveFeePercent.Int()) / PERCENTAGE_DECIMALS;
        int256 netAssetToAccount = preFeeAssetToAccount - fee;

        netSyToAccount = netAssetToAccount < 0
            ? index.assetToSyUp(netAssetToAccount)
            : index.assetToSy(netAssetToAccount);
        netSyFee = index.assetToSy(fee);
        netSyToReserve = index.assetToSy(netAssetToReserve);
    }
```

where:

1. `fee`  corresponds to $$feeRateRoot^{yearsToExpiry(t)}$$ as described in the whitepaper.
2. `netPtToAccount` corresponds to $$d_{pt}$$ in the whitepaper.
3. A key divergence to note: The whitepaper defines $$d_{asset}=\frac{d_{pt}}{exchangeRate(t)}$$ while in the `calcTrade` function, we define $$d_{asset}=-\frac{d_{pt}}{exchangeRate(t)}$$:

```
int256 preFeeAssetToAccount = netPtToAccount.divDown(preFeeExchangeRate).neg();
```

#### Approximation Method for Explicit Fee Calculation

When $$d_{pt}$$ is either above or below zero, the fee computation takes two forms, which can be challenging to implement in a real trading environment. To address this, we propose the following approximation method:
$$
fee=d_{assets}\times fee tier \times yearsToExpiry(t)
$$
 For instance, let’s say Alice wants to swap 1000 USDe → 1100 PT-USDe under the following conditions:

- 6 months before maturity
- AMM Fees: 0.3%
  - We charge 0.3% in APY
- Absolute fees Percentage:   0.3% * 0.5 = 0.15%
- Absolute amount = 1000 * 0.15% = 1.5 USDe

This approximation holds because, as $$feeRateRoot \rightarrow 1$$ (i.e., $$feetier \rightarrow 0$$),  the limits of the following expressions converge to zero:

1. $$lim_{feeRateRoot\rightarrow1}(feeRateRoot-1)\cdot yearsToExpiry(t)=0$$
2. $$lim_{feeRateRoot\rightarrow1}feeRateRoot^{yearsToExpiry(t)}-1=0$$
3. $$lim_{feeRateRoot\rightarrow1}-\frac{1-feeRateRoot^{yearsToExpiry(t)}}{feeRateRoot^{yearsToExpiry(t)}}=0$$

#### YT-related Fees

In V2, YT swaps are facilitated through flash swaps within the same pool. Typically, YT swaps incur higher fees than PT swaps.

For example, suppose Bob wants to swap 50 USDe → 1100 YT-USDe:

- This is equivalent to a 1100 PT swap.
- Fees = 1000 USDe\*0.3%\*0.5=1.5 USDe.

Even though the amount of assets involved is only 50 USDe, the fees generated are the same as those in Alice’s case, where she swaps 1000 USDe → 1100 PT-USDe.

### Implicit Fees

It is important to clarify that **implicit fees are not caused by the price impact (slippage)** inherent in the AMM model.

#### Price Impact

Before diving into the Pendle V2 case, let's first consider Uniswap V2 as an example.

Suppose there is a pool containing $$x$$ amount of A tokens and $$y$$ amount of B tokens. When we use $$dx$$ A tokens to swap for $$dy$$ B tokens, we derive the equation:
$$
(x+dx)(y-dy)=k
$$
Thus, we can express $$dy$$ as:
$$
dy=\frac{y\cdot dx}{x+dx}
$$
In an actual swap, the price of this transaction in terms of B tokens is:
$$
\frac{dx}{dy}=\frac{x+dx}{y}
$$
However, before the swap, the price is $$\frac{x}{y}$$, so the **slippage** is:
$$
Slippage_y=\frac{dx}{dy}-\frac{x}{y}=\frac{dx}{y}
$$
It is obvious that as $$dx$$ increases, becomes larger.

Now, let's return to the Pendle V2 case. According to the V2_AMM whitepaper, if a user *u* buys $$d_{pt}$$ PT from the market, the actual swap price is 
$$
\begin{aligned}
\frac{d_{pt}}{d_{asset}}&\equiv exchangeRate_{trade}\\
&=\left(\frac{ln\frac{p_{trade}(t)}{1-p_{trade}(t)}}{rateScalar(t)}+rateAnchor(t)\right)\times or \div feeRateRoot^{yearsToExpiry(t)}
\end{aligned}
$$
where,
$$
p_{trade}(t)=\frac{n_{pt}(t*)-d_{pt}}{n_{pt}(t*)+n_{asset}(t*)}
$$
Before the transaction, the price is 
$$
exchangeRate=\frac{ln\frac{p(t)}{1-p(t)}}{rateScalar(t)}+rateAnchor(t)
$$
Accordingly, the slippage is
$$
\begin{aligned}
Slippage&=exchangeRate_{trade}-exchangeRate
\end{aligned}
$$
Expanding the full expression leads to a more complex derivation.

#### Definition of Implicit Fee

Unfortunately, **implicit fees** are not the same as price impact, as clarified above.

For example, if the current market rate is 15%, a large trade might have an average APY of 16% (1% higher than the market rate). In this case, part of the 1% difference is due to price impact, while the rest is attributable to implicit fees.

If the user splits the large trade into infinitely small amounts, the average APY might drop to 15.8%, for example. Here, 0.8% represents the pure price impact, and 0.2% is the implicit fees.

Thus, we can define implicit fees as follows:

**Implicit Fees** = The additional cost to the user compared to trading an infinitesimally small amount until the full trade is completed, excluding the portion of the cost caused by price impact.

## Evaluation of Efficient Ratio







## References

1. [MarketMathCore.sol - WORKSPACE - Blockscan contract source code viewer](https://vscode.blockscan.com/ethereum/0x40789E8536C668c6A249aF61c81b9dfaC3EB8F32)
2. [PendleMarketV3.sol - WORKSPACE - Blockscan contract source code viewer](https://vscode.blockscan.com/ethereum/0x40789E8536C668c6A249aF61c81b9dfaC3EB8F32)