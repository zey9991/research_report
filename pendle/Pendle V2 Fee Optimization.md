# Background

In Pendle V2, a variety of AMM pools are available, allowing traders to swap assets for PT, YT, or vice versa. The swap fee plays a crucial role in shaping the user experience. If the fee is set incorrectly, it can have the following effects:

- **Too High**: This would deter traders from swapping, ultimately reducing the profits of LPs and vePendle voters. Although the fee per transaction may increase, the overall volume of swaps would decrease.
- **Too Low**: This would undermine the profits of LPs and vePendle voters, even though the volume of swaps might increase significantly.

This situation is analogous to a **market competition model** in economics. In such models, a company’s revenue is given by $$R= P \times Q$$, where $$P$$ is the price and $$Q$$ is the quantity sold. If the price is set incorrectly, the revenue will not be optimized, even though the quantity $$Q$$ may increase.

Previously, our team introduced the “Efficient Ratio” as an indicator to measure the effectiveness of fee settings in specific pools. In this data-driven report, we aim to explore the following:

- Has the “Efficient Ratio” functioned well in evaluating the effectiveness of fee settings? If not, is there a more suitable alternative indicator?
- How do different fee tiers affect the “Efficient Ratio”? What is the optimal range according to historical data?

# Fee Calculation

In Pendle V2 AMM, there are two types of fees:

- **Explicit Fee**: These are the fees charged according to the specific fee tier of each pool, as displayed in the app. The distribution is as follows:
  - 20% is allocated to LP holders.
  - 80% is distributed to vePENDLE voters.
- **Implicit Fee**: These fees are generated by the formula used to quote the price for each swap. 
  - The formula is “relatively protective of the AMM pool,” meaning it quotes a conservative price to prevent potential exploitation of the AMM. The larger the trade, the higher the implicit fees.
  - They are not the same as price impact (slippage) in general. They are “on the top” of price impact.
  - 100% is allocated to the LP holders

In this section, we will provide a detailed explanation of these two types of fees.

## Explicit Fees

In V2, the explicit fees are described in the whitepaper `V2_AMM.pdf` and implemented in the smart contracts `MarketMathCore.sol` (Core Logic) and `PendleMarketV3.sol`.

The whitepaper defines the amount of assets going in, denoted as $$d_{asset}$$  as a function of the amount of PT tokens going out, denoted as $$d_{pt}$$:

$$
d_{asset}=\frac{d_{pt}}{exchangeRate(t)}\div or \times feeRateRoot^{yearsToExpiry(t)}
$$
where,

- $$exchangeRate(t)$$ is the spot exchange rate of asset in PT at time $$t$$, excluding any fees
- $$feeRateRoot=1+feetier$$
- $$yearsToExpiry(t)$$ is the time remaining until expiry, measured in years

Accordingly, the fee can be computed as follows:

- if $$d_{pt}>0$$ i.e. swapping assets for PT, then 

  $$
  d_{asset}=\frac{d_{pt}}{exchangeRate(t)}\times feeRateRoot^{yearsToExpiry(t)}
  $$
  The fee is:

  $$
  fee=\frac{d_{pt}}{exchangeRate(t)}(feeRateRoot^{yearsToExpiry(t)}-1)
  $$

- if $$d_{pt}<0$$  i.e. swapping PT for assets, then 

  $$
  d_{asset}=\frac{d_{pt}}{exchangeRate(t)}\div feeRateRoot^{yearsToExpiry(t)}
  $$
  The fee is:
  
  $$
  fee=-\frac{d_{pt}}{exchangeRate(t)}(\frac{1-feeRateRoot^{yearsToExpiry(t)}}{feeRateRoot^{yearsToExpiry(t)}})
  $$
  

This logic is implemented in the `calcTrade` function of `MarketMathCore.sol`. The relevant source code is as follows:

```solidity
function calcTrade(
        MarketState memory market,
        MarketPreCompute memory comp,
        PYIndex index,
        int256 netPtToAccount
    ) internal pure returns (int256 netSyToAccount, int256 netSyFee, int256 netSyToReserve) {
        int256 preFeeExchangeRate = _getExchangeRate(
            market.totalPt,
            comp.totalAsset,
            comp.rateScalar,
            comp.rateAnchor,
            netPtToAccount
        );

        int256 preFeeAssetToAccount = netPtToAccount.divDown(preFeeExchangeRate).neg();
        int256 fee = comp.feeRate;

        if (netPtToAccount > 0) {
            int256 postFeeExchangeRate = preFeeExchangeRate.divDown(fee);
            if (postFeeExchangeRate < PMath.IONE) revert Errors.MarketExchangeRateBelowOne(postFeeExchangeRate);

            fee = preFeeAssetToAccount.mulDown(PMath.IONE - fee);
        } else {
            fee = ((preFeeAssetToAccount * (PMath.IONE - fee)) / fee).neg();
        }

        int256 netAssetToReserve = (fee * market.reserveFeePercent.Int()) / PERCENTAGE_DECIMALS;
        int256 netAssetToAccount = preFeeAssetToAccount - fee;

        netSyToAccount = netAssetToAccount < 0
            ? index.assetToSyUp(netAssetToAccount)
            : index.assetToSy(netAssetToAccount);
        netSyFee = index.assetToSy(fee);
        netSyToReserve = index.assetToSy(netAssetToReserve);
    }
```

where:

1. `fee`  corresponds to $$feeRateRoot^{yearsToExpiry(t)}$$ as described in the whitepaper.
2. `netPtToAccount` corresponds to $$d_{pt}$$ in the whitepaper.
3. A key divergence to note: The whitepaper defines $$d_{asset}=\frac{d_{pt}}{exchangeRate(t)}$$ while in the `calcTrade` function, we define $$d_{asset}=-\frac{d_{pt}}{exchangeRate(t)}$$:

```
int256 preFeeAssetToAccount = netPtToAccount.divDown(preFeeExchangeRate).neg();
```

### Approximation Method for Explicit Fee Calculation

When $$d_{pt}$$ is either above or below zero, the fee computation takes two forms, which can be challenging to implement in a real trading environment. To address this, we propose the following approximation method:
$$
fee=d_{assets}\times fee tier \times yearsToExpiry(t)
$$
 For instance, let’s say Alice wants to swap 1000 USDe → 1100 PT-USDe under the following conditions:

- 6 months before maturity
- AMM Fees: 0.3%
  - We charge 0.3% in APY
- Absolute fees Percentage:   0.3% * 0.5 = 0.15%
- Absolute amount = 1000 * 0.15% = 1.5 USDe

This approximation holds because, as $$feeRateRoot \rightarrow 1$$ (i.e., $$feetier \rightarrow 0$$),  the limits of the following expressions converge to zero:

1. $$lim_{feeRateRoot\rightarrow1}(feeRateRoot-1)\cdot yearsToExpiry(t)=0$$
2. $$lim_{feeRateRoot\rightarrow1}feeRateRoot^{yearsToExpiry(t)}-1=0$$
3. $$lim_{feeRateRoot\rightarrow1}-\frac{1-feeRateRoot^{yearsToExpiry(t)}}{feeRateRoot^{yearsToExpiry(t)}}=0$$

### YT-related Fees

In V2, YT swaps are facilitated through flash swaps within the same pool. Typically, YT swaps incur higher fees than PT swaps.

For example, suppose Bob wants to swap 50 USDe → 1100 YT-USDe:

- This is equivalent to a 1100 PT swap.
- Fees = 1000 USDe \* 0.3% \* 0.5=1.5 USDe.

Even though the amount of assets involved is only 50 USDe, the fees generated are the same as those in Alice’s case, where she swaps 1000 USDe → 1100 PT-USDe.

## Implicit Fees

It is important to clarify that **implicit fees are not caused by the price impact (slippage)** inherent in the AMM model.

### Price Impact

Before diving into the Pendle V2 case, let's first consider Uniswap V2 as an example.

Suppose there is a pool containing $$x$$ amount of A tokens and $$y$$ amount of B tokens. When we use $$dx$$ A tokens to swap for $$dy$$ B tokens, we derive the equation:
$$
(x+dx)(y-dy)=k
$$
Thus, we can express $$dy$$ as:
$$
dy=\frac{y\cdot dx}{x+dx}
$$
In an actual swap, the price of this transaction in terms of B tokens is:
$$
\frac{dx}{dy}=\frac{x+dx}{y}
$$
However, before the swap, the price is $$\frac{x}{y}$$, so the **slippage** is:
$$
Slippage_y=\frac{dx}{dy}-\frac{x}{y}=\frac{dx}{y}
$$
It is obvious that as $$dx$$ increases, becomes larger.

Now, let's return to the Pendle V2 case. According to the `V2_AMM` whitepaper, if a user *u* buys $$d_{pt}$$ PT from the market, the actual swap price is 
$$
\begin{aligned}
\frac{d_{pt}}{d_{asset}}&\equiv exchangeRate_{trade}\\
&=\left(\frac{ln\frac{p_{trade}(t)}{1-p_{trade}(t)}}{rateScalar(t)}+rateAnchor(t)\right)\times or \div feeRateRoot^{yearsToExpiry(t)}
\end{aligned}
$$
where,
$$
p_{trade}(t)=\frac{n_{pt}(t*)-d_{pt}}{n_{pt}(t*)+n_{asset}(t*)}
$$
Before the transaction, the price is 
$$
exchangeRate=\frac{ln\frac{p(t)}{1-p(t)}}{rateScalar(t)}+rateAnchor(t)
$$
Accordingly, the slippage is
$$
\begin{aligned}
Slippage&=exchangeRate_{trade}-exchangeRate
\end{aligned}
$$
Expanding the full expression leads to a more complex derivation. 

### Definition of Implicit Fee

Unfortunately, **implicit fees** are not the same as price impact, as clarified above.

For example, if the current market rate is 15%, a large trade might have an average APY of 16% (1% higher than the market rate). In this case, part of the 1% difference is due to price impact, while the rest is attributable to implicit fees.

If the user splits the large trade into infinitely small amounts, the average APY might drop to 15.8%, for example. Here, 0.8% represents the pure price impact, and 0.2% is the implicit fees.

Thus, we can define implicit fees as follows:

**Implicit Fees** = The additional cost to the user compared to trading an infinitesimally small amount until the full trade is completed, excluding the portion of the cost caused by price impact.

# Efficient Ratio

From a user's perspective, the fee incurred in each transaction is an important consideration. However, from the protocol's point of view, the focus is on the overall fees generated by a pool over time, which reflects its revenue. 

Since pools can differ in terms of start date, expiry date, TVL, underlying assets, and other factors, comparing pools based solely on total fees may not be meaningful. 

Therefore, our team introduces **Efficient Ratio** to assess the **capital efficiency** of specific pools. Below is how it is calculated:


$$
\begin{aligned}
&EfficientRatio=\frac{Average\ Daily\ Swap\ Fee * 365}{ Average\ Daily\ LP\ TVL}
\end{aligned}
$$
It compares the total annualized swap fees to the average daily TVL (Total Value Locked) of the pool. A higher ratio indicates that the pool generates more fees for each unit of liquidity provided, which suggests better operational efficiency.

### How to Understand it?

The efficient ratio is similar to a financial ratio in traditional finance (TradFi): **asset turnover ratio**, which is typically defined as:
$$
\text{Asset Turnover Ratio}=\frac{\text{Sales Revenue}}{\text{Average Total Assets}}
$$
The asset turnover ratio measures how effectively a company uses its total assets to generate revenue. It reflects the amount of sales or revenue generated for every unit of asset employed.

In this context:

- **Annualized Daily Swap Fees** are analogous to revenue.
- **Average Daily LP TVL** corresponds to average total assets.

Thus, the Efficient Ratio serves a similar purpose, indicating how effectively a pool utilizes its assets to generate revenue.

**Additional Considerations**

- Unlike the traditional asset turnover ratio, the numerator here is the annualized daily "revenue" to reduce the influence of different maturity date of pools.
- The average daily swap fees encompass all explicit and implicit fees, as well as limit order fees, measuring the overall revenue for all beneficiaries, including Liquidity Providers (LPs) and vePendle voters. Ideally, the denominator should also account for the value of vePendle votes to maintain accuracy. However, for simplicity and ease of interpretation, we focus solely on the LP TVL in the denominator.

# Modeling the Relationship 

In this section, we aim to explore the relationship between fee tiers and efficient ratios. We have tried out three different models to capture the statistical relationship. Each of them are followed by sensitivity and heterohestic analyses.

## Dataset Description

The dataset used in this report can be accessed via the following link:

{% embed url="" %}

**Note:** Data was accessed on February 8, 2025.

### Data Preprocessing

We have preemptively removed 17 pool samples with missing data, including:

- sETH-wstEthSilo 28MAR2024
- vETH-WETH_BalancerLP Aura 26SEP2024
- ether.fi eBTC 27MAR2025
- Venus BNB 26JUN2025
- PENDLE-ETH_Camelot 26JUN2025
- Staking MNT 26DEC2024
- Sophon Farming PEPE 26DEC2024
- mPendle 26DEC2024
- oETH 25DEC2025
- Stargate USDT 27JUN2024
- Stargate USDT 27JUN2024
- gDAI 26DEC2024
- Ethena USDe 31OCT2024
- Ethena sUSDE 31OCT2024
- Zircuit Staking USDe 22AUG2024

- Kyber Elastic axlWstEth-wstETH 28MAR2024
- Staked ePENDLE 26DEC2024

### Descriptive Statistics

Below is a summary of key statistics for the dataset:

| pool               | Fee Tier | AverageIY | Average Daily LP TVL   | Total Swap Fee    | Total Swap Fee (im+ex) | Average Daily Swap Fee | EfficientRatio* | EfficientRatioB** |
| ------------------ | -------- | --------- | ---------------------- | ----------------- | ---------------------- | ---------------------- | --------------- | ----------------- |
| Minimum            | 0.03%    | 2.20%     | 62,036.00              | 96.00             | 207.62                 | 1.45                   | 0.03%           | 0.00%             |
| Maximum            | 3.00%    | 153.40%   | 128,584,588.00         | 1,897,019.00      | 2,471,809.24           | 16,640.52              | 75.19%          | 235.00%           |
| Average            | 0.21%    | 16.25%    | 11,518,886.41          | 64,581.49         | 113,792.33             | 742.86                 | 4.97%           | 14.77%            |
| Median             | 0.10%    | 9.50%     | 4,350,257.00           | 4,464.00          | 9,986.41               | 56.80                  | 1.57%           | 5.00%             |
| Standard Deviation | 0.29%    | 19.12%    | 19,660,958.27          | 182,101.40        | 289,744.22             | 1,965.29               | 9.62%           | 25.05%            |
| Variance           | 0.000008 | 0.04      | 386,553,279,972,616.00 | 33,160,920,898.11 | 83,951,710,675.30      | 3,862,348.99           | 0.01            | 0.06              |
| Skewness           | 5.08     | 4.05      | 3.08                   | 5.86              | 4.55                   | 4.56                   | 4.45            | 4.57              |
| Kurtosis           | 39.53    | 22.78     | 11.05                  | 47.35             | 26.54                  | 25.96                  | 24.38           | 30.36             |

**Statistical Observations**

- **Right-Skewed Distribution (Positive Skewness):** Most variables exhibit strong positive skewness, indicating that the distributions have long right tails. This suggests that while the majority of pools operate within a relatively small range, a few pools have significantly higher values, pulling the mean upward.
- **Leptokurtic Distributions (High Kurtosis):** The kurtosis values for most variables are extremely high (e.g., **Total Swap Fee = 47.35**, **Efficient RatioB = 30.36**), indicating **fat-tailed** distributions. This means that extreme values (outliers) occur more frequently than in a normal distribution. In other words, while most pools cluster around lower values, a few outliers experience extremely high activity.

### Scatter Plot

Before we proceed with modeling the relationship between Fee Tier and Efficient Ratio, we can visually examine their relationship using scatter plots.

Below is the scatter plot showing the Fee Tier vs. Efficient Ratio, categorized by **Base Asset**:

![Scatter Plot of Fee Tier vs. Efficient Ratio (By BaseAsset)](https://cdn.jsdelivr.net/gh/zey9991/mdpic/scatterEffRatioandFeeTierByBaseAsset.png)

Overall, most pools have Fee Tier settings between 0% and 1.0%, particularly within the 0% to 0.5% range. Efficient Ratios are mostly concentrated in the 0% to 20% range. There doesn’t seem to be a very strong monotonic relationship between the two variables, and further analysis during the modeling phase will provide more clarity on the exact nature of the relationship.

When grouped by **Base Asset**, we observe that most BTC-based pools tend to have both lower Fee Tier and Efficient Ratio values. On the other hand, pools with other base assets show more variability in both Fee Tier and Efficient Ratio, with some extreme values even exceeding 40% for Efficient Ratio.

**Yield Source** can be seen as a more detailed categorization of Base Asset. Below is the scatter plot grouped by **Yield Source**:

![Scatter Plot of Fee Tier vs. Efficient Ratio (By YieldSource)](https://cdn.jsdelivr.net/gh/zey9991/mdpic/scatterEffRatioandFeeTierByYieldSource.png)

We can also group the data based on the **chain** to create another scatter plot:

![Scatter Plot of Fee Tier vs. Efficient Ratio (By Chain)](https://cdn.jsdelivr.net/gh/zey9991/mdpic/scatterEffRatioandFeeTierByChain.png)

The majority of pools are deployed on **ETH (id: 1)**, and these pools show considerable variation in both Fee Tier and Efficient Ratio. The next largest group is on **Arbitrum One (id: 42161)**, where the relationship between Fee Tier and Efficient Ratio appears more positively correlated. Other chains have fewer pools, resulting in sparse data points, making it difficult to conclusively assess the relationship. To provide more insight, we can also group the data by both **Base Asset** and **Chain**:

![Scatter Plot of Fee Tier vs. Efficient Ratio (By BaseAsset and Chain)](https://cdn.jsdelivr.net/gh/zey9991/mdpic/scatterEffRatioandFeeTierByBaseAssetandChain.png)

This chart provides a clearer picture:

- On chains like **Op Mainnet (id:10)**, **BSC (id:56)**, **Mantle (id:5000)**, and **Base (id:8453)**, Fee Tier is mostly concentrated between 0% and 1%, with Efficient Ratios typically not very high. In the case of a higher Fee Tier (1%), only a stablecoin asset pool (Ethena USDe 25JUL2024) on the **Mantle** chain has an Efficient Ratio exceeding 20%. Here, the relationship between Fee Tier and Efficient Ratio is closer to a monotonic positive correlation.
- On **Arbitrum One (id:42161)**, where asset types are more diverse, the relationship between Fee Tier and Efficient Ratio also appears to be a monotonic positive correlation. With a 1% Fee Tier, two ETH-based asset pools have an Efficient Ratio greater than 20%.
- The situation on **Ethereum (id:1)** is more complex. While many data points show a positive correlation between Fee Tier and Efficient Ratio, there are still several observations that deviate from this pattern.

Similarly, scatter plots can be created based on **Yield Source** and **Chain**. Since Yield Source is a more granular categorization compared to Base Asset, it serves as a valuable supplement to the previous visualizations:

![Scatter Plot of Fee Tier vs. Efficient Ratio (By YieldSource and Chain)](https://cdn.jsdelivr.net/gh/zey9991/mdpic/scatterEffRatioandFeeTierByYieldSourceandChain.png)

## Quadratic Regression Model

In this section, we consider using a quadratic regression model to attempt to describe the relationship between **Fee Tier** and **Efficient Ratio**, based primarily on the following expectations outlined at the beginning of the paper:

- If the **Fee Tier** is set too high, this will increase the trader's transaction costs. Although LPs and vePendle voters earn more fees per transaction, the overall increase in transaction costs will lead to a decrease in trader activity, which will ultimately reduce the pool's swap fees and lower the **Efficient Ratio**.
- Conversely, if the **Fee Tier** is set too low, it may increase trader activity but results in too little fee income per transaction for LPs and vePendle voters, causing the **Efficient Ratio** to also decrease.

This theory is simple and persuasive. According to this, the relationship between **Fee Tier** and **Efficient Ratio** is expected to exhibit an inverted U-shape (nonlinear relationship). Therefore, we should not use a simple linear regression model, but rather consider a nonlinear model with quadratic or higher-order terms to capture this relationship.

Specifically, we first set up the quadratic regression model as follows:
$$
EfficientRatio=\beta_1+\beta_2FeeTier+\beta_3FeeTier^2+\sum_i \beta_iControls+\epsilon_i
$$
Where:

- $$\beta$$ represents the parameters to be estimated:
  - $$\beta_1$$ is the intercept term of the model. When **Fee Tier** is 0, both **Explicit Fees** and **Limit Order Fees** are 0, so it represents the impact of **Implicit Fees** on the **Efficient Ratio**.
  - We are particularly concerned with the sign of $$\beta_3$$. To demonstrate the inverted U-shape relationship between **Fee Tier** and **Efficient Ratio**, the estimated value of $$\beta_3$$ should be negative.
- $$Controls$$ represents a set of control variables, which include:
  - **Duration** (the pool's lifespan), measured in days. This variable is added to account for the fact that pools are typically more active when they are newly launched, but their trading volume may decline over time, leading to a reduction in the **Efficient Ratio**.
  - **BaseAsset** (the pool's underlying asset): a dummy variable. Market participants may choose different base assets based on market cycles or personal preferences, so we include this variable to capture these effects.
  - We did not include additional dummy variables like **Yield Source** and **Chain** because we found that their inclusion caused perfect multicollinearity among certain variables, which forced us to exclude them. We will explore these variables further in a sensitivity analysis.
- $$\epsilon_i$$ is the error term of the model.

The parameters of the above model can still be estimated using ordinary least squares (OLS), provided the following assumptions hold:

- The model is correctly specified.
- The explanatory variables are nonlinearly correlated.
- The error terms exhibit no autocorrelation.

The estimation results are shown in the table below. To account for potential heteroscedasticity in the error terms, robust standard errors are used.



From the results, we see that the regression coefficient for the quadratic term is positive, which is opposite to our expectation, and it is not statistically significant. The 95% confidence interval for the quadratic term is very wide, ranging from -144.1299 to 1276.973. From this, we can draw the following conclusions:

- If the inverted U-shape theory is correct, the lack of statistical evidence for this relationship may be due to insufficient data, model specification errors, omitted explanatory variables, outliers, or other statistical issues.
- If the inverted U-shape theory is incorrect, we will need to abandon the previous assumption and adjust the model structure to more accurately capture the relationship between **Fee Tier** and **Efficient Ratio**.



## Threshold Regression Model



## References

1. [MarketMathCore.sol - WORKSPACE - Blockscan contract source code viewer](https://vscode.blockscan.com/ethereum/0x40789E8536C668c6A249aF61c81b9dfaC3EB8F32)
2. [PendleMarketV3.sol - WORKSPACE - Blockscan contract source code viewer](https://vscode.blockscan.com/ethereum/0x40789E8536C668c6A249aF61c81b9dfaC3EB8F32)